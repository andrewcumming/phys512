

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>Non-linear least squares &#8212; PHYS 512 Computational Physics with Applications</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6" />
  <script src="_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=365ca57ee442770a23c6"></script>

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'nonlinear';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Solutions to exercises" href="solving_solutions.html" />
    <link rel="prev" title="Polynomial fitting" href="polynomial_fit.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/plasma.png" class="logo__image only-light" alt="PHYS 512 Computational Physics with Applications - Home"/>
    <script>document.write(`<img src="_static/plasma.png" class="logo__image only-dark" alt="PHYS 512 Computational Physics with Applications - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">About the course</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="outline.html">Course outline</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting started</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="basics.html">Getting set up</a></li>
<li class="toctree-l1"><a class="reference internal" href="programming.html">Programming best practices</a></li>
<li class="toctree-l1"><a class="reference internal" href="floats.html">Floating point arithmetic</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Manipulating functions</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="derivatives.html">Derivatives</a></li>
<li class="toctree-l1"><a class="reference internal" href="interpolation.html">Interpolation</a></li>
<li class="toctree-l1"><a class="reference internal" href="integration.html">Integration</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="function_solutions.html">Solutions to exercises</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="derivatives_solutions.html">Derivatives exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="interpolation_solutions.html">Interpolation exercises</a></li>
<li class="toctree-l2"><a class="reference internal" href="integration_solutions.html">Integration exercises</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Random numbers</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="random.html">Random numbers</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcg.html">Linear Congruential Generators</a></li>
<li class="toctree-l1"><a class="reference internal" href="generating_random.html">Probability distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="monte_carlo_integration.html">Monte Carlo integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="metropolis.html">Metropolis-Hastings algorithm</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="random_solutions.html">Solutions to exercises</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="prob_distributions_solutions.html">Probability distributions Exercise 1</a></li>
<li class="toctree-l2"><a class="reference internal" href="prob_distributions_solutions_part2.html">Probability distributions Part 2</a></li>
<li class="toctree-l2"><a class="reference internal" href="montecarlo_solutions.html">Monte Carlo Integration</a></li>
<li class="toctree-l2"><a class="reference internal" href="metropolis_solutions.html">Metropolis-Hastings</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Solving systems of equations</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="matrices.html">Matrices in numpy</a></li>

<li class="toctree-l1"><a class="reference internal" href="linear_least_squares.html">Linear least squares</a></li>
<li class="toctree-l1"><a class="reference internal" href="polynomial_fit.html">Polynomial fitting</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Non-linear least squares</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="solving_solutions.html">Solutions to exercises</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="polynomial_fit_solutions.html">Orthogonal polynomials</a></li>
<li class="toctree-l2"><a class="reference internal" href="nonlinear_fit.html">Lorentzian fit</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Machine Learning</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="mllecture.html">Machine Learning</a></li>

<li class="toctree-l1"><a class="reference internal" href="chatgpt.html">ChatGPT ‘Real-Life Example’</a></li>
<li class="toctree-l1"><a class="reference internal" href="mltensorflow.html">Example : Higgs Boson</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Differential equations</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="runge_kutta.html">Initial value problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="boundary_value_problems.html">Boundary value problems</a></li>
<li class="toctree-l1"><a class="reference internal" href="symplectic.html">Symplectic integrators</a></li>
<li class="toctree-l1"><a class="reference internal" href="laplace.html">Poisson’s equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="conjugate_gradient.html">Sparse matrices</a></li>
<li class="toctree-l1"><a class="reference internal" href="numerical_instability.html">Boundary conditions and numerical stability</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="ode_solutions.html">Solutions to exercises</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="runge_kutta_solutions.html">Initial value problems</a></li>
<li class="toctree-l2"><a class="reference internal" href="bvps.html">Boundary value problems</a></li>
<li class="toctree-l2"><a class="reference internal" href="symplectic_solutions.html">Symplectic integrators</a></li>
<li class="toctree-l2"><a class="reference internal" href="conjugate_gradient_solutions.html">Conjugate gradient solutions</a></li>
</ul>
</li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Homework</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="hw1.html">Homework 1</a></li>
<li class="toctree-l1"><a class="reference internal" href="hw2.html">Homework 2</a></li>
<li class="toctree-l1"><a class="reference internal" href="hw3.html">Homework 3</a></li>
<li class="toctree-l1"><a class="reference internal" href="hw4.html">Homework 4</a></li>
<li class="toctree-l1"><a class="reference internal" href="hw5.html">Homework 5</a></li>
<li class="toctree-l1"><a class="reference internal" href="hw6.html">Homework 6</a></li>
<li class="toctree-l1"><a class="reference internal" href="project_instructions.html">Project Instructions</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="homework_solutions.html">Homework solutions</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-5"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="HW1_solutions.html">Homework 1 solutions</a></li>
<li class="toctree-l2"><a class="reference internal" href="HW2_solutions.html">Homework 2 solutions</a></li>
<li class="toctree-l2"><a class="reference internal" href="homework_notes/hw2_common_issues.html">Homework 2: Common Issues</a></li>














<li class="toctree-l2"><a class="reference internal" href="HW3_solutions.html">Homework 3 solutions</a></li>
<li class="toctree-l2"><a class="reference internal" href="HW4_solutions.html">Homework 4 solutions</a></li>
<li class="toctree-l2"><a class="reference internal" href="HW5_solutions.html">Homework 5 solutions</a></li>
</ul>
</li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/andrewcumming/phys512" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/andrewcumming/phys512/issues/new?title=Issue%20on%20page%20%2Fnonlinear.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/nonlinear.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Non-linear least squares</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#newton-s-method">Newton’s method</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#application-to-least-squares-fitting">Application to least-squares fitting</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#levenberg-marquardt">Levenberg-Marquardt</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="non-linear-least-squares">
<h1>Non-linear least squares<a class="headerlink" href="#non-linear-least-squares" title="Permalink to this heading">#</a></h1>
<p>Now let’s discuss what happens if we have a non-linear model <span class="math notranslate nohighlight">\(m(x,\vec{a})\)</span> that we want to fit to a set of measurements <span class="math notranslate nohighlight">\(y_i(x_i)\)</span>. We want to minimize</p>
<div class="math notranslate nohighlight">
\[\chi^2 = \sum_{i=1}^N \left[{y_i - m(x_i, \vec{a})\over \sigma_i}  \right]^2.\]</div>
<p>We’ll first discuss Newton’s method and its application to least-squares, and then a generalization of this method, Levenberg-Marquardt.</p>
<section id="newton-s-method">
<h2>Newton’s method<a class="headerlink" href="#newton-s-method" title="Permalink to this heading">#</a></h2>
<p>The simplest way to see how Newton’s method works is to consider a one-dimensional function <span class="math notranslate nohighlight">\(f(x)\)</span>. We would like to find the value of <span class="math notranslate nohighlight">\(x\)</span> that minimises <span class="math notranslate nohighlight">\(f(x)\)</span>. Given a current guess for the location of the minimum, <span class="math notranslate nohighlight">\(x_n\)</span>, we first write down a quadratic expansion around <span class="math notranslate nohighlight">\(x_n\)</span>:</p>
<div class="math notranslate nohighlight">
\[f(x) = f(x_n) + (x-x_n) \left.{df\over dx}\right|_{x_n} + {(x-x_n)^2\over 2} \left.{d^2f\over dx^2}\right|_{x_n}.\]</div>
<p>We find an updated value for the location of the minimum <span class="math notranslate nohighlight">\(x_{n+1}\)</span> by minimizing this quadratic expansion:</p>
<div class="math notranslate nohighlight">
\[{df\over dx}=0 \Rightarrow \left.{df\over dx}\right|_{x_n} + (x_{n+1} -x_n) \left.{d^2f\over dx^2}\right|_{x_n}=0\]</div>
<div class="math notranslate nohighlight" id="equation-newton">
<span class="eqno">(1)<a class="headerlink" href="#equation-newton" title="Permalink to this equation">#</a></span>\[\Rightarrow x_{n+1} = x_n - \left(\left.{d^2f\over dx^2}\right|_{x_n}\right)^{-1} \left.{df\over dx}\right|_{x_n}.\]</div>
<p>To the extent the function is locally well-approximated by a quadratic, this update should take us closer to the minimum. Newton’s method is to iteratively apply equation <a class="reference internal" href="#equation-newton">(1)</a> until it converges, for example when the fractional change in <span class="math notranslate nohighlight">\(x\)</span> is smaller than a threshold.</p>
<p>Following through the same argument in multi-dimensions, the quadratic expansion becomes</p>
<div class="math notranslate nohighlight">
\[f(\vec{x}) = f(\vec{x_n}) + (\vec{x}-\vec{x_n})\cdot\vec{\nabla} f(\vec{x_n}) + {1\over 2}(\vec{x}-\vec{x_n})\cdot \mathbf{H} \cdot (\vec{x}-\vec{x_n}),\]</div>
<p>where <span class="math notranslate nohighlight">\(\mathbf{H}\)</span> is the <em>Hessian matrix</em></p>
<div class="math notranslate nohighlight">
\[(\mathbf{H})_{ij} = {\partial^2 f\over \partial x_i\partial x_j}.\]</div>
<p>The update becomes</p>
<div class="math notranslate nohighlight" id="equation-newtonmultid">
<span class="eqno">(2)<a class="headerlink" href="#equation-newtonmultid" title="Permalink to this equation">#</a></span>\[\vec{x_{n+1}} = \vec{x_n} - \mathbf{H}^{-1}\cdot\vec{\nabla} f(\vec{x_n}).\]</div>
</section>
<section id="application-to-least-squares-fitting">
<h2>Application to least-squares fitting<a class="headerlink" href="#application-to-least-squares-fitting" title="Permalink to this heading">#</a></h2>
<p>To apply this to least-squares, we first need the gradient of <span class="math notranslate nohighlight">\(\chi^2\)</span> with respect to the parameters, <span class="math notranslate nohighlight">\(\vec{\nabla} \chi^2\)</span>, whose <span class="math notranslate nohighlight">\(k\)</span>-th component is given by</p>
<div class="math notranslate nohighlight">
\[{\partial \chi^2\over\partial a_k} = -2 \sum_i \left[{y_i - m(x_i, \vec{a})\over \sigma_i}  \right] {1\over \sigma_i} {\partial m(x_i, \vec{a})\over\partial a_k}.\]</div>
<p>If we define the matrix</p>
<div class="math notranslate nohighlight">
\[A_{ik} \equiv {1\over \sigma_i} {\partial m(x_i, \vec{a})\over\partial a_k}\]</div>
<p>and the residual vector <span class="math notranslate nohighlight">\(\mathbf{r}\)</span> with <span class="math notranslate nohighlight">\(i\)</span>-th component</p>
<div class="math notranslate nohighlight">
\[r_i = {y_i - m(x_i, \vec{a})\over \sigma_i}\]</div>
<p>then we have</p>
<div class="math notranslate nohighlight" id="equation-gradchi2">
<span class="eqno">(3)<a class="headerlink" href="#equation-gradchi2" title="Permalink to this equation">#</a></span>\[{1\over 2} {\partial \chi^2\over\partial a_k} = - \sum_i A_{ik} r_i\]</div>
<p>or in matrix form</p>
<div class="math notranslate nohighlight" id="equation-gradchi2vec">
<span class="eqno">(4)<a class="headerlink" href="#equation-gradchi2vec" title="Permalink to this equation">#</a></span>\[{1\over 2} \vec{\nabla} \chi^2 = - \mathbf{A^T}\mathbf{r}.\]</div>
<p>We can find the Hessian matrix by taking another derivative of equation <a class="reference internal" href="#equation-gradchi2">(3)</a>, giving</p>
<div class="math notranslate nohighlight">
\[{1\over 2} {\partial^2 \chi^2\over\partial a_k \partial a_\ell} = \sum_i A_{ik}A_{i\ell} + \sum_i r_i {\partial^2 m(x_i)\over \partial a_k \partial a_\ell}.\]</div>
<p>The second term involving the second derivative of the model is usually dropped with the argument that near the best-fitting solution, <span class="math notranslate nohighlight">\(r_i\)</span> should be small, especially when summed over <span class="math notranslate nohighlight">\(i\)</span> and positive and negative values cancel. Neglecting this term, we get</p>
<div class="math notranslate nohighlight" id="equation-hessian">
<span class="eqno">(5)<a class="headerlink" href="#equation-hessian" title="Permalink to this equation">#</a></span>\[{1\over 2} {\partial^2 \chi^2\over\partial a_k \partial a_\ell} = (\mathbf{A^T}\mathbf{A})_{k\ell}.\]</div>
<p>Now plugging equations <a class="reference internal" href="#equation-gradchi2vec">(4)</a> and <a class="reference internal" href="#equation-hessian">(5)</a> into the Newton’s method update (eq. <a class="reference internal" href="#equation-newtonmultid">(2)</a>), we find</p>
<div class="math notranslate nohighlight" id="equation-newtonupdate">
<span class="eqno">(6)<a class="headerlink" href="#equation-newtonupdate" title="Permalink to this equation">#</a></span>\[\vec{a}_{n+1} = \vec{a}_n + (\mathbf{A^T}\mathbf{A})^{-1} \mathbf{A^T} \mathbf{r}.\]</div>
<p>Starting with an initial guess for the parameters, we can apply this rule iteratively until (hopefully) we converge on the best fit (ie. the set of parameters that minimizes <span class="math notranslate nohighlight">\(\chi^2\)</span>).</p>
<div class="admonition-exercise-lorentzian-fit admonition">
<p class="admonition-title">Exercise: Lorentzian fit</p>
<p>Let’s apply this method to fit a set of data points with a Lorentzian</p>
<div class="math notranslate nohighlight">
\[ f(x) = {a_0\over a_1 + (x-a_2)^2}.\]</div>
<p>The following function takes a vector of parameters for the Lorentzian <span class="math notranslate nohighlight">\(\vec{a}=(a_0,a_1,a_2)\)</span> and a set of <span class="math notranslate nohighlight">\(x\)</span> values and returns <span class="math notranslate nohighlight">\(f(x)\)</span> and the matrix <span class="math notranslate nohighlight">\(\mathbf{A}\)</span>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="k">def</span> <span class="nf">lorentz</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="c1"># Calculates the Lorentz function and analytic derivatives </span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">A</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)])</span>
        <span class="n">A</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">A</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">A</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">A</span>
</pre></div>
</div>
<p>In this function, we populate the matrix <span class="math notranslate nohighlight">\(\mathbf{A}\)</span> with the derivatives of the Lorentzian with respect to each of the parameters. As usual, for simplicity we assume constant errors <span class="math notranslate nohighlight">\(\sigma_i\)</span> so that they cancel out of the equations.</p>
<p>Now generate a set of measurements including some Gaussian noise:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mf">1.2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">))</span>   <span class="c1"># &#39;true&#39; parameters of the Lorentzian</span>
<span class="n">ndata</span> <span class="o">=</span> <span class="mi">100</span>   <span class="c1"># number of measurements </span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">ndata</span><span class="p">)</span>
<span class="n">y</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">lorentz</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> 
<span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">0.03</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">ndata</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Implement Newton’s method to fit the data points <span class="math notranslate nohighlight">\(y(x)\)</span> with a Lorentzian function. Start with a guess for the parameters and use equation <a class="reference internal" href="#equation-newtonupdate">(6)</a> to iteratively improve the guess. As a stopping criterion, you could monitor the size of the residual and stop when it falls below a certain value (e.g. <code class="docutils literal notranslate"><span class="pre">np.sqrt(np.mean(r**2))</span></code>). [Depending on your initial guess, you might also get cases where the algorithm does not converge, in which case it will never reach your stopping criterion. One way to look out for these cases is to stop when the error gets larger after an iteration rather than getting smaller.]</p></li>
<li><p>Once you converge on an answer for the best-fit parameters, plot the corresponding Lorentzian on top of your data points to confirm visually that you are getting a good fit. Also, compare your best-fitting parameters with the input parameters used to generate the measurements.</p></li>
<li><p>Next, modify the <code class="docutils literal notranslate"><span class="pre">lorentz</span></code> function so that it calculates the <span class="math notranslate nohighlight">\(\mathbf{A}\)</span> matrix using finite differences rather than analytic derivatives. Check that you get the same answer as before.</p></li>
</ul>
</div>
</section>
<section id="levenberg-marquardt">
<h2>Levenberg-Marquardt<a class="headerlink" href="#levenberg-marquardt" title="Permalink to this heading">#</a></h2>
<p>You might have noticed in the exercise that Newton’s method doesn’t always converge. For the parameters given above, if you start at <span class="math notranslate nohighlight">\((a_0,a_1,a_2)=(1,1,1)\)</span> then you should converge on the correct solution pretty quickly, but choosing <span class="math notranslate nohighlight">\((1,1,4)\)</span> as a starting point instead leads to a diverging solution. Levenberg-Marquardt is a modification of Newton’s method that often leads to a more robust solution. The algorithm is:</p>
<ul class="simple">
<li><p>Define a parameter <span class="math notranslate nohighlight">\(\lambda\)</span> with a small starting value, e.g. <span class="math notranslate nohighlight">\(\lambda=10^{-3}\)</span>.</p></li>
<li><p>Solve as with Newton’s method, but multiply the diagonal elements of <span class="math notranslate nohighlight">\(\mathbf{A^T}\mathbf{A}\)</span> by <span class="math notranslate nohighlight">\((1+\lambda)\)</span>. So <code class="docutils literal notranslate"><span class="pre">A.T&#64;A</span></code> becomes <code class="docutils literal notranslate"><span class="pre">A.T&#64;A&#64;(np.identity(len(a))*(1+lambda))</span></code>.</p></li>
<li><p>If <span class="math notranslate nohighlight">\(\chi^2\)</span> with the new parameters <span class="math notranslate nohighlight">\(\vec{a}_{n+1}\)</span> is greater than with the current set of parameters <span class="math notranslate nohighlight">\(\vec{a}_n\)</span>, then increase <span class="math notranslate nohighlight">\(\lambda\)</span> by a factor of 10, go back to <span class="math notranslate nohighlight">\(\vec{a}_n\)</span> and try again.</p></li>
<li><p>If <span class="math notranslate nohighlight">\(\chi^2(\vec{a}_{n+1})\)</span> is smaller than <span class="math notranslate nohighlight">\(\chi^2(\vec{a}_n)\)</span>, then reduce <span class="math notranslate nohighlight">\(\lambda\)</span> by a factor of 10 and accept the step <span class="math notranslate nohighlight">\(\vec{a}_n\rightarrow \vec{a}_{n+1}\)</span>.</p></li>
</ul>
<p>The way this works is that if things are going well (<span class="math notranslate nohighlight">\(\chi^2\)</span> is decreasing) then <span class="math notranslate nohighlight">\(\lambda\)</span> stays small and the update is basically the same as Newton’s method. However, if <span class="math notranslate nohighlight">\(\chi^2\)</span> starts increasing, <span class="math notranslate nohighlight">\(\lambda\)</span> grows, making the diagonal of <span class="math notranslate nohighlight">\(\mathbf{A^T}\mathbf{A}\)</span> dominant. The update is then <span class="math notranslate nohighlight">\(\delta\vec{a}\propto -\vec{\nabla}\chi^2\)</span>, in the direction of the gradient of <span class="math notranslate nohighlight">\(\chi^2\)</span>, which is a <em>steepest descent</em> method. The steepest descent method is inefficient when applied by itself, but in combination with Newton’s method like this is a very powerful algorithm for moving towards the minimum.</p>
<div class="admonition-exercise-lorentzian-fit-part-2 admonition">
<p class="admonition-title">Exercise: Lorentzian fit part 2</p>
<p>Update your Lorentzian fitting routine to use Levenberg-Marquardt. Try it out and see whether it fixes the convergence issues you were seeing with Newton’s method.</p>
<p>Finally, try doing the fit using <a class="reference external" href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.least_squares.html"><code class="docutils literal notranslate"><span class="pre">scipy.optimize.least_squares</span></code></a> instead.</p>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="polynomial_fit.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Polynomial fitting</p>
      </div>
    </a>
    <a class="right-next"
       href="solving_solutions.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Solutions to exercises</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#newton-s-method">Newton’s method</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#application-to-least-squares-fitting">Application to least-squares fitting</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#levenberg-marquardt">Levenberg-Marquardt</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By <a href="https://www.physics.mcgill.ca/~cumming/">Andrew Cumming</a>
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023, CC BY SA 4.0.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>